<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Касса — Аптека «Любовь»</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f4f8; color: #2c3e50; padding: 12px; }
    .container { max-width: 1000px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    h1 { color: #c0392b; font-size: 24px; }
    .subtitle { font-size: 14px; color: #7f8c8d; margin-top: 4px; }
    .input-area {
      display: flex; gap: 10px; margin-bottom: 16px;
      flex-wrap: wrap;
    }
    input, button, select { padding: 10px; font-size: 16px; border: 1px solid #bdc3c7; border-radius: 4px; }
    input { flex: 1; min-width: 220px; }
    button { cursor: pointer; background: #3498db; color: white; border: none; }
    button:hover { background: #2980b9; }
    button.alt { background: #9b59b6; }
    button.f2 { background: #2ecc71; }
    button.loyalty { background: #f39c12; }
    .cart {
      background: white; border: 1px solid #ecf0f1; border-radius: 6px;
      padding: 12px; margin-bottom: 16px; max-height: 320px; overflow-y: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex; justify-content: space-between; padding: 6px 0;
      border-bottom: 1px dashed #eee;
    }
    .total {
      font-size: 20px; font-weight: bold; text-align: right;
      margin: 12px 0; color: #27ae60;
    }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .actions button { flex: 1; min-width: 130px; }
    .price-check {
      margin-top: 10px; padding: 10px; background: #fff9c4; border-left: 4px solid #fbc02d;
      display: none; font-weight: bold;
    }
    .barcode-display {
      margin-top: 16px; text-align: center; padding: 12px; background: white;
      border-radius: 6px; display: none;
    }
    .barcode-display img {
      max-width: 100%; height: auto;
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .modal h3 { margin-bottom: 15px; }
    .product-item {
      padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
    }
    .product-item:hover { background: #f0f8ff; }
    .online-order, .loyalty-section, .archive-section, .search-results {
      margin-top: 20px; padding: 16px; border-radius: 6px; display: none;
    }
    .online-order { border: 1px dashed #8e44ad; background: #f9f0ff; }
    .loyalty-section { border: 1px solid #f39c12; background: #fff8e1; }
    .archive-section { border: 1px solid #16a085; background: #e8f5f2; }
    .search-results { border: 1px solid #3498db; background: #ebf5fb; }
    .search-results div { padding: 6px; cursor: pointer; border-bottom: 1px solid #d6eaf8; }
    .search-results div:hover { background: #d6eaf8; }
    @media (max-width: 600px) {
      .input-area, .actions { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Аптека «Любовь» — Касса</h1>
      <div class="subtitle">ИНН: 7701234567 | г. Москва, ул. Здоровья, д. 10</div>
    </header>

    <div class="input-area">
      <input type="text" id="mainInput" placeholder="Введите штрихкод (13 цифр) или название..." autocomplete="off" autofocus />
      <button id="manualBtn">Ручной ввод (Shift)</button>
      <button class="alt" id="priceCheckBtn">Цена (Alt)</button>
    </div>

    <div class="search-results" id="searchResults"></div>
    <div class="price-check" id="priceCheck">Цена: <span id="priceValue"></span> руб.</div>

    <div class="cart" id="cart">
      <p>Корзина пуста</p>
    </div>

    <div class="total">
      Итого: <span id="totalAmount">0</span> руб.
      <br><small id="loyaltyBonus">Бонусы: 0</small>
    </div>

    <div class="actions">
      <button id="cancelItem">Отменить товар</button>
      <button id="checkoutBtn">Оплатить</button>
      <button class="f2" id="generateBarcodeBtn">Создать штрихкод (F2)</button>
      <button class="loyalty" id="loyaltyBtn">Лояльность</button>
      <button id="archiveBtn">Архив</button>
      <button id="onlineOrderBtn">Онлайн-заказ</button>
    </div>

    <div class="barcode-display" id="barcodeDisplay">
      <h4>Сгенерированный штрихкод</h4>
      <img id="barcodeImage" src="" alt="Штрихкод" />
      <p id="barcodeCode"></p>
    </div>
  </div>

  <!-- Модальное окно выбора препарата для F2 -->
  <div class="modal" id="productSelectModal">
    <div class="modal-content">
      <h3>Выберите препарат для генерации штрихкода</h3>
      <input type="text" id="productSearchModal" placeholder="Поиск по названию..." style="width:100%; margin-bottom:10px;" />
      <div id="productListModal"></div>
    </div>
  </div>

  <!-- Онлайн-заказ -->
  <div class="online-order" id="onlineOrderForm">
    <h3>Онлайн-заказ</h3>
    <input type="text" id="clientName" placeholder="ФИО клиента" />
    <input type="tel" id="clientPhone" placeholder="Телефон (+7...)" />
    <textarea id="orderItems" placeholder="Список препаратов (по одному на строку)"></textarea>
    <button id="submitOrder">Отправить заказ</button>
    <div class="status" id="orderStatus"></div>
  </div>

  <!-- Лояльность -->
  <div class="loyalty-section" id="loyaltyForm">
    <h3>Карта лояльности</h3>
    <input type="tel" id="loyaltyPhone" placeholder="Телефон (+7...)" />
    <button id="checkLoyalty">Проверить карту</button>
    <div id="loyaltyInfo" style="margin-top:10px;"></div>
  </div>

  <!-- Архив -->
  <div class="archive-section" id="archiveForm">
    <h3>Архив заказов и чеков</h3>
    <input type="text" id="archiveQuery" placeholder="ФИО, телефон или дата (ДД.ММ.ГГГГ)" />
    <button id="searchArchive">Найти</button>
    <div id="archiveResults" style="margin-top:10px; max-height:300px; overflow-y:auto;"></div>
  </div>

  <script>
    // === Firebase Init ===
    const firebaseConfig = {
      databaseURL: "https://apteka-lyubov-default-rtdb.firebaseio.com/"
    };
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.warn("Firebase не инициализирован");
    }

    // === Генерация валидного EAN-13 ===
    function generateEAN13(prefix = "2000000") {
      let base = prefix + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        let digit = parseInt(base[i]);
        sum += (i % 2 === 0) ? digit * 1 : digit * 3;
      }
      let checkDigit = (10 - (sum % 10)) % 10;
      return base + checkDigit;
    }

    // === Генерация 520 препаратов ===
    function generatePharmacyCatalog(count = 520) {
      const commonNames = [
        "Парацетамол", "Ибупрофен", "Аспирин", "Но-шпа", "Супрастин", "Цетрин", "Лоратадин",
        "Омез", "Альмагель", "Энтеросгель", "Анальгин", "Диазолин", "Фуросемид", "Каптоприл",
        "Метопролол", "Амлодипин", "Витамин C", "Витамин D3", "Магний B6", "Глицин", "Корвалол",
        "Валокордин", "Нитроглицерин", "Спазган", "Кетанов", "Нурофен", "Терафлю", "Колдрекс",
        "Аугментин", "Амоксициллин", "Азитромицин", "Ципрофлоксацин", "Флуконазол", "Нистатин",
        "Линекс", "Хилак Форте", "Мезим", "Панкреатин", "Эспумизан", "Дюфалак", "Лактулоза",
        "Афобазол", "Фенибут", "Пантогам", "Глицин форте", "Мексидол", "Пирацетам", "Церебролизин",
        "Актовегин", "Кавинтон", "Бетасерк", "Винпоцетин", "Танакан", "Гинкоум", "Циннаризин",
        "Нейромидин", "Артра", "Терафлекс", "Дона", "Хондроитин", "Глюкозамин", "Мовалис",
        "Диклофенак", "Мелоксикам", "Нимесулид", "Ксефокам", "Баралгин", "Спазмалгон", "Темпалгин"
      ];
      const catalog = {};
      for (let i = 0; i < count; i++) {
        const name = commonNames[Math.floor(Math.random() * commonNames.length)] + " №" + (i + 1);
        const price = Math.floor(Math.random() * 1900) + 100; // 100–2000 руб.
        const code = generateEAN13("2000000");
        catalog[code] = { name, price };
      }
      return catalog;
    }

    // === State ===
    let CATALOG = generatePharmacyCatalog(520);
    let cart = [];
    let currentUser = null;

    // === DOM ===
    const mainInput = document.getElementById('mainInput');
    const searchResults = document.getElementById('searchResults');
    const cartEl = document.getElementById('cart');
    const totalEl = document.getElementById('totalAmount');
    const loyaltyBonusEl = document.getElementById('loyaltyBonus');
    const priceCheckEl = document.getElementById('priceCheck');
    const priceValueEl = document.getElementById('priceValue');
    const barcodeDisplay = document.getElementById('barcodeDisplay');
    const barcodeImage = document.getElementById('barcodeImage');
    const barcodeCode = document.getElementById('barcodeCode');
    const productSelectModal = document.getElementById('productSelectModal');
    const productListModal = document.getElementById('productListModal');
    const productSearchModal = document.getElementById('productSearchModal');
    const onlineOrderForm = document.getElementById('onlineOrderForm');
    const loyaltyForm = document.getElementById('loyaltyForm');
    const archiveForm = document.getElementById('archiveForm');

    // === Инициализация ===
    console.log("Каталог загружен:", Object.keys(CATALOG).length, "препаратов");
    updateCart();

    // === Utils ===
    function updateCart() {
      if (cart.length === 0) {
        cartEl.innerHTML = '<p>Корзина пуста</p>';
        totalEl.textContent = '0';
        loyaltyBonusEl.textContent = 'Бонусы: 0';
        return;
      }
      cartEl.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `<span>${item.name} (${item.code})</span><span>${item.price} ₽</span>`;
        cartEl.appendChild(div);
        total += item.price;
      });
      totalEl.textContent = total;
      loyaltyBonusEl.textContent = `Бонусы: +${Math.floor(total * 0.05)}`;
    }

    function addToCart(code) {
      if (!CATALOG[code]) {
        alert(`Препарат не найден`);
        return;
      }
      cart.push({ code, ...CATALOG[code] });
      updateCart();
      mainInput.value = '';
      searchResults.style.display = 'none';
    }

    function generateBarcodeImage(code) {
      const url = `https://barcode.tec-it.com/barcode.ashx?data=${code}&code=EAN13&multiplebarcodes=false&translate-esc=on&unit=Fit&dpi=96`;
      barcodeImage.src = url;
      barcodeCode.textContent = `Код: ${code}`;
      barcodeDisplay.style.display = 'block';
    }

    // === Поиск по названию (основное поле) ===
    mainInput.addEventListener('input', () => {
      const query = mainInput.value.trim().toLowerCase();
      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }
      const results = [];
      for (const [code, prod] of Object.entries(CATALOG)) {
        if (prod.name.toLowerCase().includes(query)) {
          results.push({ code, ...prod });
          if (results.length >= 10) break;
        }
      }
      if (results.length > 0) {
        searchResults.innerHTML = '';
        results.forEach(item => {
          const div = document.createElement('div');
          div.textContent = `${item.name} — ${item.price} ₽ [${item.code}]`;
          div.onclick = () => {
            addToCart(item.code);
            searchResults.style.display = 'none';
          };
          searchResults.appendChild(div);
        });
        searchResults.style.display = 'block';
      } else {
        searchResults.style.display = 'none';
      }
    });

    // === F2: выбор препарата для генерации штрихкода ===
    document.getElementById('generateBarcodeBtn').addEventListener('click', () => {
      renderProductListForModal('');
      productSelectModal.style.display = 'flex';
    });

    productSearchModal.addEventListener('input', () => {
      const q = productSearchModal.value.trim().toLowerCase();
      renderProductListForModal(q);
    });

    function renderProductListForModal(query) {
      productListModal.innerHTML = '';
      const entries = Object.entries(CATALOG);
      let count = 0;
      for (const [code, prod] of entries) {
        if (!query || prod.name.toLowerCase().includes(query)) {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.textContent = `${prod.name} — ${prod.price} ₽`;
          div.onclick = () => {
            generateBarcodeImage(code);
            productSelectModal.style.display = 'none';
          };
          productListModal.appendChild(div);
          count++;
          if (count >= 50) break; // ограничение для производительности
        }
      }
      if (count === 0) {
        productListModal.innerHTML = '<p>Препараты не найдены</p>';
      }
    }

    // === Закрытие модалки по клику вне ===
    window.addEventListener('click', (e) => {
      if (e.target === productSelectModal) {
        productSelectModal.style.display = 'none';
      }
    });

    // === Остальные кнопки ===
    document.getElementById('manualBtn').addEventListener('click', () => {
      const code = prompt('Введите 13-значный штрихкод:');
      if (code && code.length === 13 && /^\d+$/.test(code)) {
        addToCart(code);
      }
    });

    document.getElementById('priceCheckBtn').addEventListener('click', () => {
      const val = mainInput.value.trim();
      if (val.length === 13 && /^\d+$/.test(val) && CATALOG[val]) {
        priceValueEl.textContent = CATALOG[val].price;
        priceCheckEl.style.display = 'block';
        setTimeout(() => priceCheckEl.style.display = 'none', 2500);
      } else {
        alert('Введите корректный 13-значный штрихкод');
      }
    });

    document.getElementById('cancelItem').addEventListener('click', () => {
      if (cart.length > 0) {
        cart.pop();
        updateCart();
      }
    });

    document.getElementById('checkoutBtn').addEventListener('click', () => {
      if (cart.length === 0) return alert('Корзина пуста');
      const total = parseFloat(totalEl.textContent);
      const paid = parseFloat(prompt(`К оплате: ${total} руб.\nВведите сумму от клиента:`));
      if (!paid || paid < total) return alert('Недостаточно средств');
      alert(`Сдача: ${(paid - total).toFixed(2)} руб.\nСпасибо за покупку!`);
      if (db) {
        db.ref('receipts').push({
          items: cart,
          total,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
      cart = [];
      updateCart();
      barcodeDisplay.style.display = 'none';
    });

    // Переключение форм
    document.getElementById('onlineOrderBtn').onclick = () => onlineOrderForm.style.display = onlineOrderForm.style.display === 'none' ? 'block' : 'none';
    document.getElementById('loyaltyBtn').onclick = () => loyaltyForm.style.display = loyaltyForm.style.display === 'none' ? 'block' : 'none';
    document.getElementById('archiveBtn').onclick = () => archiveForm.style.display = archiveForm.style.display === 'none' ? 'block' : 'none';

    // Онлайн-заказ
    document.getElementById('submitOrder').addEventListener('click', async () => {
      const name = document.getElementById('clientName').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();
      const items = document.getElementById('orderItems').value.trim();
      if (!name || !phone || !items) return alert('Заполните все поля');
      if (db) {
        await db.ref('online-orders').push({ name, phone, items, status: 'новый', timestamp: firebase.database.ServerValue.TIMESTAMP });
        document.getElementById('orderStatus').textContent = '✅ Заказ отправлен!';
        setTimeout(() => onlineOrderForm.style.display = 'none', 2000);
      } else {
        alert('Заказ сохранён локально');
      }
    });

    // Лояльность (упрощённо)
    document.getElementById('checkLoyalty').addEventListener('click', () => {
      const phone = document.getElementById('loyaltyPhone').value.trim();
      if (!phone) return alert('Введите телефон');
      alert(`Карта для ${phone} найдена. Бонусов: 120`);
      currentUser = { phone, bonus: 120 };
    });

    // Архив
    document.getElementById('searchArchive').addEventListener('click', () => {
      const q = document.getElementById('archiveQuery').value.trim();
      const res = document.getElementById('archiveResults');
      res.innerHTML = q ? `<p>Результаты по запросу "${q}":</p><p>Чек №123 от 10.04.2025 — 1 250 ₽</p>` : '<p>Введите запрос</p>';
    });

    // === Горячие клавиши ===
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('generateBarcodeBtn').click();
      }
      if (e.altKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('priceCheckBtn').click();
      }
      if (e.shiftKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('manualBtn').click();
      }
    });
  </script>
</body>
</html>
