
    <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Касса — Аптека «Любовь»</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f4f8; color: #2c3e50; padding: 12px; }
    .container { max-width: 1000px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    h1 { color: #c0392b; font-size: 24px; }
    .subtitle { font-size: 14px; color: #7f8c8d; margin-top: 4px; }
    .input-area {
      display: flex; gap: 10px; margin-bottom: 16px;
      flex-wrap: wrap;
    }
    input, button { padding: 10px; font-size: 16px; border: 1px solid #bdc3c7; border-radius: 4px; }
    input { flex: 1; min-width: 220px; }
    button { cursor: pointer; background: #3498db; color: white; border: none; }
    button:hover { background: #2980b9; }
    button.alt { background: #9b59b6; }
    button.f2 { background: #2ecc71; }
    button.card { background: #e74c3c; }
    .cart {
      background: white; border: 1px solid #ecf0f1; border-radius: 6px;
      padding: 12px; margin-bottom: 16px; max-height: 320px; overflow-y: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex; justify-content: space-between; padding: 6px 0;
      border-bottom: 1px dashed #eee;
    }
    .total {
      font-size: 20px; font-weight: bold; text-align: right;
      margin: 12px 0; color: #27ae60;
    }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .actions button { flex: 1; min-width: 130px; }
    .price-check {
      margin-top: 10px; padding: 10px; background: #fff9c4; border-left: 4px solid #fbc02d;
      display: none; font-weight: bold;
    }
    .barcode-display {
      margin-top: 16px; text-align: center; padding: 12px; background: white;
      border-radius: 6px; display: none;
    }
    .barcode-display img {
      max-width: 100%; height: auto;
      image-rendering: pixelated;
      border: 1px solid #ddd;
    }
    .receipt {
      background: white; padding: 20px; border: 1px solid #333; border-radius: 8px;
      font-family: monospace; font-size: 14px; white-space: pre-line;
      max-width: 500px; margin: 20px auto; display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .product-item {
      padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
    }
    .product-item:hover { background: #f0f8ff; }
    @media (max-width: 600px) {
      .input-area, .actions { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Аптека «Любовь» — Касса</h1>
      <div class="subtitle">ИНН: 7701234567 | г. Москва, ул. Здоровья, д. 10</div>
    </header>

    <div class="input-area">
      <input type="text" id="mainInput" placeholder="Сканируйте штрихкод или введите 13 цифр..." autocomplete="off" autofocus />
      <button id="manualBtn">Ручной ввод (Shift)</button>
      <button class="alt" id="priceCheckBtn">Цена (Alt)</button>
    </div>

    <div class="price-check" id="priceCheck">Цена: <span id="priceValue"></span> руб.</div>

    <div class="cart" id="cart">
      <p>Корзина пуста</p>
    </div>

    <div class="total">
      Итого: <span id="totalAmount">0</span> руб.
    </div>

    <div class="actions">
      <button id="cancelItem">Отменить товар</button>
      <button class="card" id="cardPaymentBtn">Оплата картой</button>
      <button class="f2" id="generateBarcodeBtn">Создать штрихкод (F2)</button>
    </div>

    <div class="barcode-display" id="barcodeDisplay">
      <h4>Штрихкод для сканирования</h4>
      <img id="barcodeImage" src="" alt="Штрихкод" />
      <p id="barcodeCode" style="margin-top:8px; font-weight:bold;"></p>
    </div>

    <div class="receipt" id="receipt"></div>
  </div>

  <!-- Модальное окно выбора препарата -->
  <div class="modal" id="productSelectModal">
    <div class="modal-content">
      <h3>Выберите препарат для генерации штрихкода</h3>
      <input type="text" id="productSearchModal" placeholder="Поиск по названию..." style="width:100%; margin-bottom:10px;" />
      <div id="productListModal"></div>
    </div>
  </div>

  <script>
    // === Firebase (замените на ваш) ===
    const firebaseConfig = {
      databaseURL: "https://apteka-lyubov-default-rtdb.firebaseio.com/"
    };
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.warn("Firebase не инициализирован");
    }

    // === Генерация валидного EAN-13 ===
    function generateEAN13(prefix = "2000000") {
      let base = prefix + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        let digit = parseInt(base[i]);
        sum += (i % 2 === 0) ? digit * 1 : digit * 3;
      }
      let checkDigit = (10 - (sum % 10)) % 10;
      return base + checkDigit;
    }

    // === Генерация каталога БЕЗ дублей "название + количество" ===
    function generatePharmacyCatalog() {
      const baseNames = [
        "Парацетамол", "Ибупрофен", "Аспирин", "Но-шпа", "Супрастин", "Цетрин", "Лоратадин",
        "Омез", "Альмагель", "Энтеросгель", "Анальгин", "Диазолин", "Фуросемид", "Каптоприл",
        "Метопролол", "Амлодипин", "Витамин C", "Витамин D3", "Магний B6", "Глицин", "Корвалол",
        "Валокордин", "Нитроглицерин", "Спазган", "Кетанов", "Нурофен", "Терафлю", "Колдрекс",
        "Аугментин", "Амоксициллин", "Азитромицин", "Ципрофлоксацин", "Флуконазол", "Нистатин",
        "Линекс", "Хилак Форте", "Мезим", "Панкреатин", "Эспумизан", "Дюфалак", "Лактулоза",
        "Афобазол", "Фенибут", "Пантогам", "Глицин форте", "Мексидол", "Пирацетам", "Церебролизин",
        "Актовегин", "Кавинтон", "Бетасерк", "Винпоцетин", "Танакан", "Гинкоум", "Циннаризин"
      ];

      const quantities = [5, 10, 12, 14, 16, 20, 24, 28, 30, 50];
      const catalog = {};
      const usedCombinations = new Set(); // для отслеживания дублей

      let count = 0;
      while (count < 520) {
        const base = baseNames[Math.floor(Math.random() * baseNames.length)];
        const qty = quantities[Math.floor(Math.random() * quantities.length)];
        const name = `${base} (${qty} шт)`;

        // Проверяем, не создавали ли уже такой препарат
        if (usedCombinations.has(name)) {
          continue; // пропускаем дубль
        }

        usedCombinations.add(name);
        const price = Math.floor(Math.random() * 1900) + 100;
        const code = generateEAN13("2000000");

        // Убеждаемся, что штрихкод уникален
        if (catalog[code]) continue;

        catalog[code] = { name, price };
        count++;
      }

      return catalog;
    }

    // === State ===
    let CATALOG = generatePharmacyCatalog();
    let cart = [];

    // === DOM ===
    const mainInput = document.getElementById('mainInput');
    const cartEl = document.getElementById('cart');
    const totalEl = document.getElementById('totalAmount');
    const priceCheckEl = document.getElementById('priceCheck');
    const priceValueEl = document.getElementById('priceValue');
    const barcodeDisplay = document.getElementById('barcodeDisplay');
    const barcodeImage = document.getElementById('barcodeImage');
    const barcodeCode = document.getElementById('barcodeCode');
    const receiptEl = document.getElementById('receipt');
    const productSelectModal = document.getElementById('productSelectModal');
    const productListModal = document.getElementById('productListModal');
    const productSearchModal = document.getElementById('productSearchModal');

    // === Инициализация ===
    console.log("Каталог загружен:", Object.keys(CATALOG).length, "уникальных препаратов");
    updateCart();

    // === Обновление корзины ===
    function updateCart() {
      if (cart.length === 0) {
        cartEl.innerHTML = '<p>Корзина пуста</p>';
        totalEl.textContent = '0';
        return;
      }
      cartEl.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `<span>${item.name} [${item.code}]</span><span>${item.price} ₽</span>`;
        cartEl.appendChild(div);
        total += item.price;
      });
      totalEl.textContent = total;
    }

    // === Добавление в корзину ===
    function addToCart(code) {
      if (!CATALOG[code]) {
        alert(`Товар с штрихкодом ${code} не найден`);
        return;
      }
      cart.push({ code, ...CATALOG[code] });
      updateCart();
      mainInput.value = '';
    }

    // === Генерация изображения штрихкода ===
    function generateBarcodeImage(code) {
      const url = `https://barcode.tec-it.com/barcode.ashx?data=${code}&code=EAN13&translate-esc=on&unit=Fit&dpi=96`;
      barcodeImage.src = url;
      barcodeCode.textContent = `Штрихкод: ${code}`;
      barcodeDisplay.style.display = 'block';
    }

    // === Генерация чека ===
    function generateReceipt(total) {
      const date = new Date().toLocaleString('ru-RU');
      let lines = [];
      lines.push("АПТЕКА «ЛЮБОВЬ»");
      lines.push("ИНН: 7701234567");
      lines.push("г. Москва, ул. Здоровья, д. 10");
      lines.push("=".repeat(32));
      lines.push("Товары:");
      cart.forEach(item => {
        lines.push(`${item.name.padEnd(25)} ${item.price} ₽`);
      });
      lines.push("=".repeat(32));
      lines.push(`ИТОГО: ${total} ₽`);
      lines.push(`Дата: ${date}`);
      lines.push("СПАСИБО ЗА ПОКУПКУ!");
      return lines.join('\n');
    }

    // === Enter после сканирования ===
    mainInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = mainInput.value.trim();
        if (val.length === 13 && /^\d+$/.test(val)) {
          addToCart(val);
        } else if (val.length > 0) {
          alert('Введите ровно 13 цифр штрихкода');
        }
      }
    });

    // === Проверка цены (Alt) ===
    document.getElementById('priceCheckBtn').addEventListener('click', () => {
      const val = mainInput.value.trim();
      if (val.length === 13 && /^\d+$/.test(val) && CATALOG[val]) {
        priceValueEl.textContent = CATALOG[val].price;
        priceCheckEl.style.display = 'block';
        setTimeout(() => priceCheckEl.style.display = 'none', 2000);
      } else {
        alert('Неверный штрихкод');
      }
    });

    // === Ручной ввод (Shift) ===
    document.getElementById('manualBtn').addEventListener('click', () => {
      const code = prompt('Введите 13-значный штрихкод:');
      if (code && code.length === 13 && /^\d+$/.test(code)) {
        addToCart(code);
      }
    });

    // === Отмена товара ===
    document.getElementById('cancelItem').addEventListener('click', () => {
      if (cart.length > 0) {
        cart.pop();
        updateCart();
      }
    });

    // === Оплата картой ===
    document.getElementById('cardPaymentBtn').addEventListener('click', () => {
      if (cart.length === 0) return alert('Корзина пуста');
      if (confirm('Подтвердить оплату картой?')) {
        const total = parseFloat(totalEl.textContent);
        const receiptText = generateReceipt(total);
        receiptEl.textContent = receiptText;
        receiptEl.style.display = 'block';
        if (db) {
          db.ref('receipts').push({
            items: cart,
            total,
            method: 'card',
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
        }
        cart = [];
        updateCart();
        barcodeDisplay.style.display = 'none';
      }
    });

    // === F2: генерация штрихкода ===
    document.getElementById('generateBarcodeBtn').addEventListener('click', () => {
      renderProductListForModal('');
      productSelectModal.style.display = 'flex';
    });

    function renderProductListForModal(query) {
      productListModal.innerHTML = '';
      let count = 0;
      for (const [code, prod] of Object.entries(CATALOG)) {
        if (!query || prod.name.toLowerCase().includes(query.toLowerCase())) {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.textContent = `${prod.name} — ${prod.price} ₽`;
          div.onclick = () => {
            generateBarcodeImage(code);
            productSelectModal.style.display = 'none';
          };
          productListModal.appendChild(div);
          count++;
          if (count >= 50) break;
        }
      }
      if (count === 0) {
        productListModal.innerHTML = '<p>Препараты не найдены</p>';
      }
    }

    productSearchModal.addEventListener('input', () => {
      renderProductListForModal(productSearchModal.value);
    });

    // Закрытие модалки
    window.addEventListener('click', (e) => {
      if (e.target === productSelectModal) {
        productSelectModal.style.display = 'none';
      }
    });

    // === Горячие клавиши ===
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('generateBarcodeBtn').click();
      }
      if (e.altKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('priceCheckBtn').click();
      }
      if (e.shiftKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('manualBtn').click();
      }
    });
  </script>
</body>
</html>
