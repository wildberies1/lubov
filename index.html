<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Касса — Аптека «Любовь»</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f4f8; color: #2c3e50; padding: 12px; }
    .container { max-width: 1000px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    h1 { color: #c0392b; font-size: 24px; }
    .subtitle { font-size: 14px; color: #7f8c8d; margin-top: 4px; }
    .input-area {
      display: flex; gap: 10px; margin-bottom: 16px;
      flex-wrap: wrap;
    }
    input, button { padding: 10px; font-size: 16px; border: 1px solid #bdc3c7; border-radius: 4px; }
    input { flex: 1; min-width: 220px; }
    button { cursor: pointer; background: #3498db; color: white; border: none; }
    button:hover { background: #2980b9; }
    button.alt { background: #9b59b6; }
    button.f2 { background: #2ecc71; }
    button.card { background: #e74c3c; }
    button.cash { background: #27ae60; }
    .cart {
      background: white; border: 1px solid #ecf0f1; border-radius: 6px;
      padding: 12px; margin-bottom: 16px; max-height: 320px; overflow-y: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex; justify-content: space-between; padding: 6px 0;
      border-bottom: 1px dashed #eee;
    }
    .total {
      font-size: 20px; font-weight: bold; text-align: right;
      margin: 12px 0; color: #27ae60;
    }
    .loyalty-section {
      margin: 12px 0;
      padding: 12px;
      background: #fff8e1;
      border-radius: 6px;
      border: 1px solid #f39c12;
    }
    .loyalty-info {
      margin-top: 8px;
      font-weight: bold;
      color: #c0392b;
    }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .actions button { flex: 1; min-width: 130px; }
    .price-check {
      margin-top: 10px; padding: 10px; background: #fff9c4; border-left: 4px solid #fbc02d;
      display: none; font-weight: bold;
    }
    .barcode-display {
      margin-top: 16px; text-align: center; padding: 12px; background: white;
      border-radius: 6px; display: none;
    }
    .barcode-display img {
      max-width: 100%; height: auto;
      image-rendering: pixelated;
      border: 1px solid #ddd;
    }
    .receipt {
      background: white; padding: 20px; border: 1px solid #333; border-radius: 8px;
      font-family: monospace; font-size: 14px; white-space: pre-line;
      max-width: 500px; margin: 20px auto; display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .product-item {
      padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
    }
    .product-item:hover { background: #f0f8ff; }
    @media (max-width: 600px) {
      .input-area, .actions { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Аптека «Любовь» — Касса</h1>
      <div class="subtitle">ИНН: 7701234567 | г. Москва, ул. Здоровья, д. 10</div>
    </header>

    <div class="input-area">
      <input type="text" id="mainInput" placeholder="Сканируйте штрихкод или введите 13 цифр..." autocomplete="off" autofocus />
      <button id="manualBtn">Ручной ввод (Shift)</button>
      <button class="alt" id="priceCheckBtn">Цена (Alt)</button>
    </div>

    <div class="price-check" id="priceCheck">Цена: <span id="priceValue"></span> руб.</div>

    <!-- Секция лояльности -->
    <div class="loyalty-section">
      <input type="tel" id="loyaltyPhone" placeholder="Телефон клиента (+7...)" style="width:100%; margin-bottom:8px;" />
      <button id="checkLoyalty">Проверить карту</button>
      <div class="loyalty-info" id="loyaltyInfo"></div>
    </div>

    <div class="cart" id="cart">
      <p>Корзина пуста</p>
    </div>

    <div class="total">
      Итого: <span id="totalAmount">0</span> руб.
    </div>

    <div class="actions">
      <button id="cancelItem">Отменить товар</button>
      <button class="cash" id="cashPaymentBtn">Наличные</button>
      <button class="card" id="cardPaymentBtn">Карта</button>
      <button class="f2" id="generateBarcodeBtn">Создать штрихкод (F2)</button>
    </div>

    <div class="barcode-display" id="barcodeDisplay">
      <h4>Штрихкод для сканирования</h4>
      <img id="barcodeImage" src="" alt="Штрихкод" />
      <p id="barcodeCode" style="margin-top:8px; font-weight:bold;"></p>
    </div>

    <div class="receipt" id="receipt"></div>
  </div>

  <!-- Модальное окно создания карты -->
  <div class="modal" id="createCardModal">
    <div class="modal-content">
      <h3>Создать карту лояльности</h3>
      <input type="text" id="newCardName" placeholder="ФИО клиента" style="width:100%; margin:8px 0;" />
      <input type="tel" id="newCardPhone" placeholder="Телефон (+7...)" style="width:100%; margin:8px 0;" />
      <button id="saveNewCard">Создать карту</button>
      <p id="createStatus" style="margin-top:10px; color:#27ae60;"></p>
    </div>
  </div>

  <!-- Модальное окно выбора препарата -->
  <div class="modal" id="productSelectModal">
    <div class="modal-content">
      <h3>Выберите препарат для генерации штрихкода</h3>
      <input type="text" id="productSearchModal" placeholder="Поиск по названию..." style="width:100%; margin-bottom:10px;" />
      <div id="productListModal"></div>
    </div>
  </div>

  <script>
    // === Firebase ===
    const firebaseConfig = {
      databaseURL: "https://apteka-lyubov-default-rtdb.firebaseio.com/"
    };
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.warn("Firebase не инициализирован");
    }

    // === Генерация EAN-13 ===
    function generateEAN13(prefix = "2000000") {
      let base = prefix + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        let digit = parseInt(base[i]);
        sum += (i % 2 === 0) ? digit * 1 : digit * 3;
      }
      let checkDigit = (10 - (sum % 10)) % 10;
      return base + checkDigit;
    }

    // === Каталог (700+ товаров) ===
    function generateRealisticCatalog() {
      const products = [
        { name: "Но-шпа", form: "табл.", pack: 12, price: 180 },
        { name: "Но-шпа", form: "табл.", pack: 24, price: 280 },
        { name: "Парацетамол", form: "табл.", pack: 10, price: 25 },
        { name: "Левомеколь", form: "мазь", pack: 40, unit: "г", price: 220 },
        { name: "Бепантен", form: "крем", pack: 30, unit: "г", price: 650 },
        { name: "Витамин D3", form: "капс.", pack: 60, price: 420 },
        { name: "Омез", form: "капс.", pack: 10, price: 240 },
        { name: "Нурофен", form: "гель", pack: 50, unit: "г", price: 320 },
        { name: "Супрастин", form: "табл.", pack: 10, price: 140 },
        { name: "Мезим", form: "табл.", pack: 20, price: 220 },
        { name: "Линекс", form: "капс.", pack: 16, price: 380 },
        { name: "Вольтарен", form: "гель", pack: 50, unit: "г", price: 420 },
        { name: "Цинковая мазь", form: "мазь", pack: 25, unit: "г", price: 60 },
        { name: "Хлоргексидин", form: "р-р", pack: 100, unit: "мл", price: 30 },
        { name: "Амитриптилин", form: "табл.", pack: 50, price: 320 },
        { name: "Метформин", form: "табл.", pack: 60, price: 280 },
        { name: "Омакор", form: "капс.", pack: 90, price: 3200 },
        { name: "Урсосан", form: "капс.", pack: 100, price: 1600 },
        { name: "Эутирокс", form: "табл.", pack: 100, price: 420 },
        { name: "Лизиноприл", form: "табл.", pack: 56, price: 240 },
        { name: "Симвастатин", form: "табл.", pack: 90, price: 280 },
        { name: "Дюфастон", form: "табл.", pack: 20, price: 620 },
        { name: "Ярина", form: "табл.", pack: 21, price: 680 },
        { name: "Элоком", form: "крем", pack: 30, unit: "г", price: 720 },
        { name: "Адвантан", form: "мазь", pack: 50, unit: "г", price: 1400 },
        { name: "Клотримазол", form: "мазь", pack: 30, unit: "г", price: 180 },
        { name: "Мирамистин", form: "р-р", pack: 100, unit: "мл", price: 520 },
        { name: "Фурацилин", form: "р-р", pack: 200, unit: "мл", price: 280 },
        { name: "Нафтизин", form: "капли", pack: 15, unit: "мл", price: 80 },
        { name: "Альбуцид", form: "капли", pack: 10, unit: "мл", price: 180 }
      ];

      const catalog = {};
      for (const p of products) {
        let displayName = p.unit 
          ? `${p.name} (${p.pack} ${p.unit})`
          : `${p.name} (${p.pack} ${p.form})`;
        const code = generateEAN13("2000000");
        catalog[code] = { name: displayName, price: p.price };
      }

      // Дополним до ~700
      const extra = ["Анальгин","Диазолин","Фуросемид","Каптоприл","Метопролол","Амлодипин","Глицин","Корвалол","Валокордин","Спазган","Кетанов","Терафлю","Колдрекс","Амоксициллин","Азитромицин","Флуконазол","Нистатин","Хилак Форте","Панкреатин","Эспумизан","Дюфалак","Лактулоза","Афобазол","Фенибут","Пантогам","Мексидол","Пирацетам","Актовегин","Кавинтон","Бетасерк","Винпоцетин","Гинкоум","Циннаризин"];
      const forms = ["табл.", "капс."];
      const packs = [10, 20, 28, 30, 50, 60, 90, 100];
      let count = Object.keys(catalog).length;
      while (count < 700) {
        const name = extra[Math.floor(Math.random() * extra.length)];
        const form = forms[Math.floor(Math.random() * forms.length)];
        const pack = packs[Math.floor(Math.random() * packs.length)];
        const price = Math.floor(Math.random() * 1500) + 50;
        const displayName = `${name} (${pack} ${form})`;
        const code = generateEAN13("2000000");
        if (!catalog[code]) {
          catalog[code] = { name: displayName, price };
          count++;
        }
      }
      return catalog;
    }

    // === State ===
    let CATALOG = generateRealisticCatalog();
    let cart = [];
    let currentUser = null; // { phone, name, bonus }

    // === DOM ===
    const mainInput = document.getElementById('mainInput');
    const cartEl = document.getElementById('cart');
    const totalEl = document.getElementById('totalAmount');
    const loyaltyPhone = document.getElementById('loyaltyPhone');
    const loyaltyInfo = document.getElementById('loyaltyInfo');
    const priceCheckEl = document.getElementById('priceCheck');
    const priceValueEl = document.getElementById('priceValue');
    const barcodeDisplay = document.getElementById('barcodeDisplay');
    const barcodeImage = document.getElementById('barcodeImage');
    const barcodeCode = document.getElementById('barcodeCode');
    const receiptEl = document.getElementById('receipt');
    const createCardModal = document.getElementById('createCardModal');
    const productSelectModal = document.getElementById('productSelectModal');
    const productListModal = document.getElementById('productListModal');
    const productSearchModal = document.getElementById('productSearchModal');

    // === Инициализация ===
    console.log("Каталог загружен:", Object.keys(CATALOG).length, "товаров");
    updateCart();

    // === Обновление корзины ===
    function updateCart() {
      if (cart.length === 0) {
        cartEl.innerHTML = '<p>Корзина пуста</p>';
        totalEl.textContent = '0';
        return;
      }
      cartEl.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `<span>${item.name} [${item.code}]</span><span>${item.price} ₽</span>`;
        cartEl.appendChild(div);
        total += item.price;
      });
      totalEl.textContent = total;
    }

    // === Добавление в корзину ===
    function addToCart(code) {
      if (!CATALOG[code]) {
        alert(`Товар с штрихкодом ${code} не найден`);
        return;
      }
      cart.push({ code, ...CATALOG[code] });
      updateCart();
      mainInput.value = '';
    }

    // === Генерация штрихкода ===
    function generateBarcodeImage(code) {
      const url = `https://barcode.tec-it.com/barcode.ashx?data=${code}&code=EAN13&translate-esc=on&unit=Fit&dpi=96`;
      barcodeImage.src = url;
      barcodeCode.textContent = `Штрихкод: ${code}`;
      barcodeDisplay.style.display = 'block';
    }

    // === Генерация чека ===
    function generateReceipt(total, paymentMethod, change = 0) {
      const date = new Date().toLocaleString('ru-RU');
      let lines = [];
      lines.push("АПТЕКА «ЛЮБОВЬ»");
      lines.push("ИНН: 7701234567");
      lines.push("г. Москва, ул. Здоровья, д. 10");
      lines.push("=".repeat(32));
      lines.push("Товары:");
      cart.forEach(item => {
        lines.push(`${item.name.padEnd(25)} ${item.price} ₽`);
      });
      lines.push("=".repeat(32));
      lines.push(`ИТОГО: ${total} ₽`);
      lines.push(`Оплата: ${paymentMethod}`);
      if (change > 0) lines.push(`Сдача: ${change} ₽`);
      if (currentUser) lines.push(`Телефон: ${currentUser.phone}`);
      lines.push(`Дата: ${date}`);
      lines.push("СПАСИБО ЗА ПОКУПКУ!");
      return lines.join('\n');
    }

    // === Enter после сканирования ===
    mainInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = mainInput.value.trim();
        if (val.length === 13 && /^\d+$/.test(val)) {
          addToCart(val);
        } else if (val.length > 0) {
          alert('Введите ровно 13 цифр штрихкода');
        }
      }
    });

    // === Проверка цены ===
    document.getElementById('priceCheckBtn').addEventListener('click', () => {
      const val = mainInput.value.trim();
      if (val.length === 13 && /^\d+$/.test(val) && CATALOG[val]) {
        priceValueEl.textContent = CATALOG[val].price;
        priceCheckEl.style.display = 'block';
        setTimeout(() => priceCheckEl.style.display = 'none', 2000);
      } else {
        alert('Неверный штрихкод');
      }
    });

    // === Ручной ввод ===
    document.getElementById('manualBtn').addEventListener('click', () => {
      const code = prompt('Введите 13-значный штрихкод:');
      if (code && code.length === 13 && /^\d+$/.test(code)) {
        addToCart(code);
      }
    });

    // === Отмена товара ===
    document.getElementById('cancelItem').addEventListener('click', () => {
      if (cart.length > 0) {
        cart.pop();
        updateCart();
      }
    });

    // === Лояльность: проверка карты ===
    document.getElementById('checkLoyalty').addEventListener('click', async () => {
      const phone = loyaltyPhone.value.trim();
      if (!phone) return alert('Введите телефон');
      if (!db) {
        alert('Режим offline: карта не найдена');
        loyaltyInfo.innerHTML = `<button onclick="document.getElementById('createCardModal').style.display='flex'">Создать карту</button>`;
        return;
      }

      const snapshot = await db.ref('loyalty').orderByChild('phone').equalTo(phone).once('value');
      if (snapshot.exists()) {
        const data = Object.values(snapshot.val())[0];
        currentUser = { key: Object.keys(snapshot.val())[0], ...data };
        loyaltyInfo.innerHTML = `Баллы: ${data.bonus || 0} ₽<br>ФИО: ${data.name}`;
      } else {
        currentUser = null;
        loyaltyInfo.innerHTML = `<button onclick="document.getElementById('createCardModal').style.display='flex'; document.getElementById('newCardPhone').value='${phone}'">Создать карту</button>`;
      }
    });

    // === Создание карты ===
    document.getElementById('saveNewCard').addEventListener('click', async () => {
      const name = document.getElementById('newCardName').value.trim();
      const phone = document.getElementById('newCardPhone').value.trim();
      if (!name || !phone) return alert('Заполните все поля');
      
      if (db) {
        const newRef = db.ref('loyalty').push({
          name, phone, bonus: 0
        });
        currentUser = { key: newRef.key, name, phone, bonus: 0 };
        document.getElementById('createStatus').textContent = 'Карта создана!';
        setTimeout(() => {
          createCardModal.style.display = 'none';
          loyaltyInfo.innerHTML = `Баллы: 0 ₽<br>ФИО: ${name}`;
        }, 1500);
      } else {
        currentUser = { name, phone, bonus: 0 };
        createCardModal.style.display = 'none';
        loyaltyInfo.innerHTML = `Баллы: 0 ₽ (offline)<br>ФИО: ${name}`;
      }
    });

    // === Закрытие модалок ===
    window.addEventListener('click', (e) => {
      if (e.target === createCardModal || e.target === productSelectModal) {
        e.target.style.display = 'none';
      }
    });

    // === Оплата наличными ===
    document.getElementById('cashPaymentBtn').addEventListener('click', async () => {
      if (cart.length === 0) return alert('Корзина пуста');
      const total = parseFloat(totalEl.textContent);
      
      let useBonus = 0;
      if (currentUser && (currentUser.bonus || 0) > 0) {
        useBonus = parseFloat(prompt(`Доступно бонусов: ${currentUser.bonus} ₽. Сколько списать?`) || '0');
        useBonus = Math.min(useBonus, currentUser.bonus, total);
      }
      
      const finalTotal = total - useBonus;
      const paid = parseFloat(prompt(`К оплате: ${finalTotal} ₽\nВведите сумму от клиента:`));
      if (!paid || paid < finalTotal) return alert('Недостаточно средств');
      
      const change = paid - finalTotal;
      const receiptText = generateReceipt(total, "Наличные", change);
      receiptEl.textContent = receiptText;
      receiptEl.style.display = 'block';
      
      // Начисление бонусов: 5% от полной суммы
      const earnedBonus = Math.floor(total * 0.05);
      let newBonus = (currentUser?.bonus || 0) - useBonus + earnedBonus;
      
      if (db && currentUser) {
        await db.ref(`loyalty/${currentUser.key}`).update({ bonus: newBonus });
      } else if (currentUser) {
        currentUser.bonus = newBonus;
      }
      
      // Сохранить чек
      if (db) {
        db.ref('receipts').push({
          items: cart,
          total,
          bonusUsed: useBonus,
          bonusEarned: earnedBonus,
          method: 'cash',
          phone: currentUser?.phone || null,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
      
      cart = [];
      updateCart();
      barcodeDisplay.style.display = 'none';
      loyaltyInfo.textContent = '';
      loyaltyPhone.value = '';
      currentUser = null;
    });

    // === Оплата картой ===
    document.getElementById('cardPaymentBtn').addEventListener('click', async () => {
      if (cart.length === 0) return alert('Корзина пуста');
      const total = parseFloat(totalEl.textContent);
      
      let useBonus = 0;
      if (currentUser && (currentUser.bonus || 0) > 0) {
        useBonus = parseFloat(prompt(`Доступно бонусов: ${currentUser.bonus} ₽. Сколько списать?`) || '0');
        useBonus = Math.min(useBonus, currentUser.bonus, total);
      }
      
      const finalTotal = total - useBonus;
      if (!confirm(`Подтвердить оплату картой на ${finalTotal} ₽?`)) return;
      
      const receiptText = generateReceipt(total, "Карта");
      receiptEl.textContent = receiptText;
      receiptEl.style.display = 'block';
      
      const earnedBonus = Math.floor(total * 0.05);
      let newBonus = (currentUser?.bonus || 0) - useBonus + earnedBonus;
      
      if (db && currentUser) {
        await db.ref(`loyalty/${currentUser.key}`).update({ bonus: newBonus });
      } else if (currentUser) {
        currentUser.bonus = newBonus;
      }
      
      if (db) {
        db.ref('receipts').push({
          items: cart,
          total,
          bonusUsed: useBonus,
          bonusEarned: earnedBonus,
          method: 'card',
          phone: currentUser?.phone || null,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
      
      cart = [];
      updateCart();
      barcodeDisplay.style.display = 'none';
      loyaltyInfo.textContent = '';
      loyaltyPhone.value = '';
      currentUser = null;
    });

    // === F2: генерация штрихкода ===
    document.getElementById('generateBarcodeBtn').addEventListener('click', () => {
      renderProductListForModal('');
      productSelectModal.style.display = 'flex';
    });

    function renderProductListForModal(query) {
      productListModal.innerHTML = '';
      let count = 0;
      for (const [code, prod] of Object.entries(CATALOG)) {
        if (!query || prod.name.toLowerCase().includes(query.toLowerCase())) {
          const div = document.createElement('div');
          div.className = 'product-item';
          div.textContent = `${prod.name} — ${prod.price} ₽`;
          div.onclick = () => {
            generateBarcodeImage(code);
            productSelectModal.style.display = 'none';
          };
          productListModal.appendChild(div);
          count++;
          if (count >= 50) break;
        }
      }
      if (count === 0) {
        productListModal.innerHTML = '<p>Препараты не найдены</p>';
      }
    }

    productSearchModal.addEventListener('input', () => {
      renderProductListForModal(productSearchModal.value);
    });

    // === Горячие клавиши ===
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('generateBarcodeBtn').click();
      }
      if (e.altKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('priceCheckBtn').click();
      }
      if (e.shiftKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('manualBtn').click();
      }
    });
  </script>
</body>
</html>
