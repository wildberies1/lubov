<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Касса — Аптека «Любовь»</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f4f8; color: #2c3e50; padding: 12px; }
    .container { max-width: 1000px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
    h1 { color: #c0392b; font-size: 24px; }
    .subtitle { font-size: 14px; color: #7f8c8d; margin-top: 4px; }
    .input-area {
      display: flex; gap: 10px; margin-bottom: 16px;
      flex-wrap: wrap;
    }
    input, button, select { padding: 10px; font-size: 16px; border: 1px solid #bdc3c7; border-radius: 4px; }
    input { flex: 1; min-width: 220px; }
    button { cursor: pointer; background: #3498db; color: white; border: none; }
    button:hover { background: #2980b9; }
    button.alt { background: #9b59b6; }
    button.f2 { background: #2ecc71; }
    button.print { background: #e67e22; }
    .cart {
      background: white; border: 1px solid #ecf0f1; border-radius: 6px;
      padding: 12px; margin-bottom: 16px; max-height: 350px; overflow-y: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid #eee;
    }
    .cart-item-info { flex: 1; }
    .cart-item-controls { display: flex; gap: 6px; }
    .cart-item-qty { width: 60px; text-align: center; }
    .stock-status { font-size: 12px; color: #7f8c8d; margin-top: 2px; }
    .in-stock { color: #27ae60; }
    .low-stock { color: #f39c12; }
    .out-of-stock { color: #e74c3c; }
    .total {
      font-size: 20px; font-weight: bold; text-align: right;
      margin: 12px 0; color: #27ae60;
    }
    .actions {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .actions button { flex: 1; min-width: 120px; }
    .price-check {
      margin-top: 10px; padding: 10px; background: #fff9c4; border-left: 4px solid #fbc02d;
      display: none; font-weight: bold;
    }
    .barcode-display {
      margin-top: 16px; text-align: center; padding: 12px; background: white;
      border-radius: 6px; display: none;
    }
    .barcode-display img {
      max-width: 100%; height: auto;
    }
    .online-order, .loyalty-section, .archive-section, .search-results, .f2-search, .recent-receipts {
      margin-top: 20px; padding: 16px; border-radius: 6px; display: none;
    }
    .online-order { border: 1px dashed #8e44ad; background: #f9f0ff; }
    .loyalty-section { border: 1px solid #f39c12; background: #fff8e1; }
    .archive-section { border: 1px solid #16a085; background: #e8f5f2; }
    .recent-receipts { border: 1px solid #8e44ad; background: #f5f9ff; }
    .search-results, .f2-search-results { 
      border: 1px solid #3498db; background: #ebf5fb; 
      max-height: 200px; overflow-y: auto;
    }
    .search-results div, .f2-search-results div { 
      padding: 6px; cursor: pointer; border-bottom: 1px solid #d6eaf8; 
    }
    .search-results div:hover, .f2-search-results div:hover { 
      background: #d6eaf8; 
    }
    .loyalty-auto { margin-top: 10px; }
    .loyalty-info { margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; }
    @media (max-width: 600px) {
      .input-area, .actions { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Аптека «Любовь» — Касса</h1>
      <div class="subtitle">ИНН: 7701234567 | г. Москва, ул. Здоровья, д. 10</div>
    </header>

    <div class="input-area">
      <input type="tel" id="loyaltyPhoneAuto" placeholder="Телефон клиента (+7...)" />
    </div>
    <div class="loyalty-auto" id="loyaltyAutoInfo"></div>

    <div class="input-area">
      <input type="text" id="mainInput" placeholder="Штрихкод (13 цифр) или название препарата..." autocomplete="off" />
      <button class="alt" id="priceCheckBtn">Цена (Alt)</button>
    </div>

    <div class="search-results" id="searchResults"></div>
    <div class="price-check" id="priceCheck">Цена: <span id="priceValue"></span> руб.</div>

    <div class="cart" id="cart">
      <p>Корзина пуста</p>
    </div>

    <div class="total">
      Итого: <span id="totalAmount">0</span> руб.
      <br><small id="loyaltyBonus">Бонусы: 0</small>
    </div>

    <div class="actions">
      <button id="cancelItem">Отменить товар</button>
      <button id="checkoutBtn">Оплатить</button>
      <button class="print" id="printReceiptBtn">Печать чека</button>
      <button class="f2" id="generateBarcodeBtn">Штрихкод (F2)</button>
      <button id="recentReceiptsBtn">Последние чеки</button>
      <button id="onlineOrderBtn">Онлайн-заказ</button>
      <button id="archiveBtn">Архив</button>
    </div>

    <!-- Последние чеки -->
    <div class="recent-receipts" id="recentReceipts">
      <h3>Последние 5 чеков</h3>
      <div id="recentReceiptsList"></div>
    </div>

    <!-- F2: выбор товара -->
    <div class="f2-search" id="f2SearchForm">
      <h3>Выберите препарат для генерации штрихкода</h3>
      <input type="text" id="f2SearchInput" placeholder="Название препарата..." />
      <div class="f2-search-results" id="f2SearchResults"></div>
    </div>

    <div class="barcode-display" id="barcodeDisplay">
      <h4>Сгенерированный штрихкод</h4>
      <img id="barcodeImage" src="" alt="Штрихкод" />
      <div id="barcodeProductInfo" style="margin-top:8px; font-size:14px;"></div>
    </div>

    <div class="online-order" id="onlineOrderForm">
      <h3>Онлайн-заказ</h3>
      <input type="text" id="clientName" placeholder="ФИО клиента" />
      <input type="tel" id="clientPhone" placeholder="Телефон (+7...)" />
      <textarea id="orderItems" placeholder="Список препаратов (по одному на строку)"></textarea>
      <button id="submitOrder">Отправить заказ</button>
      <div class="status" id="orderStatus"></div>
    </div>

    <div class="archive-section" id="archiveForm">
      <h3>Архив заказов и чеков</h3>
      <input type="text" id="archiveQuery" placeholder="ФИО, телефон или дата (ДД.ММ.ГГГГ)" />
      <button id="searchArchive">Найти</button>
      <div id="archiveResults" style="margin-top:10px; max-height:300px; overflow-y:auto;"></div>
    </div>
  </div>

  <script>
    // === ЗВУК ===
    let audioContext = null;
    function initAudio() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    function playSuccessBeep() {
      if (document.hidden) return;
      try {
        initAudio();
        const o = audioContext.createOscillator();
        const g = audioContext.createGain();
        o.connect(g); g.connect(audioContext.destination);
        o.frequency.value = 880; o.type = 'sine';
        g.gain.setValueAtTime(0.1, audioContext.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
        o.start(); o.stop(audioContext.currentTime + 0.08);
      } catch (e) { console.warn("Звук недоступен"); }
    }
    function playErrorBeep() {
      if (document.hidden) return;
      try {
        initAudio();
        const o = audioContext.createOscillator();
        const g = audioContext.createGain();
        o.connect(g); g.connect(audioContext.destination);
        o.frequency.value = 220; o.type = 'sine';
        g.gain.setValueAtTime(0.08, audioContext.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
        o.start(); o.stop(audioContext.currentTime + 0.15);
      } catch (e) { console.warn("Звук недоступен"); }
    }

    // === Firebase ===
    const firebaseConfig = { databaseURL: "https://apteka-lyubov-default-rtdb.firebaseio.com/" };
    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch (e) { console.warn("Firebase не инициализирован"); }

    // === Генерация EAN-13 ===
    function generateEAN13(prefix = "2000000") {
      let base = prefix + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        let digit = parseInt(base[i]);
        sum += (i % 2 === 0) ? digit * 1 : digit * 3;
      }
      let checkDigit = (10 - (sum % 10)) % 10;
      return base + checkDigit;
    }

    // === Каталог с наличием ===
    function generatePharmacyCatalog(count = 720) {
      const names = ["Парацетамол","Ибупрофен","Аспирин","Но-шпа","Супрастин","Цетрин","Лоратадин","Омез","Альмагель","Энтеросгель","Анальгин","Диазолин","Фуросемид","Каптоприл","Метопролол","Амлодипин","Витамин C","Витамин D3","Магний B6","Глицин","Корвалол","Валокордин","Нитроглицерин","Спазган","Кетанов","Нурофен","Терафлю","Колдрекс","Аугментин","Амоксициллин","Азитромицин","Ципрофлоксацин","Флуконазол","Нистатин","Линекс","Хилак Форте","Мезим","Панкреатин","Эспумизан","Дюфалак","Лактулоза","Бисопролол","Эналаприл","Лизиноприл","Верошпирон","Конкор","Преднизолон","Дексаметазон","Гидрокортизон","Метформин","Инсулин","Левотироксин","Эутирокс","Кавинтон","Циннаризин","Пирацетам","Фенибут","Афобазол","Тенотен","Ново-Пассит","Валериана","Пустырник","Мелисса","Ромашка","Эхинацея","Иммунал","Арбидол","Кагоцел","Анаферон","Виферон","Генферон","Ацикловир","Валацикловир","Метронидазол","Орнидазол","Нимесулид","Мовалис","Диклофенак","Вольтарен","Ксефокам","Мидокалм","Сирдалуд","Баклофен","Нейромультивит","Комбилипен","Мильгамма","Актовегин","Церебролизин","Пирацетам","Фенотропил","Глиатилин","Цераксон","Кавинтон Форте","Бетасерк","Вестибо","Танакан","Гинкоум","Билобил","Трентал","Курантил","Кардиомагнил","Аспекард","Тромбо АСС","Клопидогрель","Варфарин","Ксарелто","Прадакса","Лосартан","Вальсартан","Телмисартан","Индапамид","Гидрохлортиазид","Амлодипин","Нифедипин","Верапамил","Дилтиазем","Атенолол","Бисопролол","Анальгин","Баралгин","Спазмалгон","Баралгин М","Темпалгин","Седалгин","Пенталгин","Нурофен Экспресс","Кеторол","Кетонал","Флексен","Долобене","Вольтарен Эмульгель","Диклофенак гель","Найз гель","Кетопрофен гель","Бепантен","Пантенол","Левомеколь","Солкосерил","Актовегин гель","Эплан","Мирамистин","Хлоргексидин","Фурацилин","Йод","Зелёнка","Перекись водорода","Активированный уголь","Смекта","Полисорб","Энтеросгель","Фосфалюгель","Ренни","Гастал","Маалокс","Омез Д","Нольпаза","Париет","Ультоп","Де-Нол","Вентер","Креон","Панзинорм","Фестал","Энзистал","Лактазар","Линекс Форте","Бифиформ","Аципол","Бифидумбактерин","Лактобактерин","Хилак Форте","Дюфалак","Форлакс","Гутталакс","Сенаде","Магния сульфат","Регидрон","Глюкосолан","Цитрагель","Витрум","Компливит","Алфавит","Супрадин","Берокка","Мульти-табс","Витамин Е","Омега-3","Коэнзим Q10","Лецитин","Глюкозамин","Хондроитин","Коллаген","Масло чёрного тмина","Прополис","Эхинацея П","Иммунал форте","Антигриппин","Фервекс","Ринза","Гриппферон","Интерферон","Оксолиновая мазь","Виферон мазь"];
      const catalog = {};
      for (let i = 0; i < count; i++) {
        const name = names[Math.floor(Math.random() * names.length)] + " №" + (i + 1);
        const price = Math.floor(Math.random() * 2500) + 80;
        const code = generateEAN13("2000000");
        // Симуляция наличия
        const stock = Math.random() > 0.1 ? (Math.random() > 0.3 ? 'in' : 'low') : 'out';
        catalog[code] = { name, price, stock };
      }
      return catalog;
    }

    // === State ===
    let CATALOG = generatePharmacyCatalog(720);
    let cart = [];
    let currentUser = null;
    let loyaltyTimeout = null;
    let recentReceipts = [];

    // === DOM ===
    const mainInput = document.getElementById('mainInput');
    const loyaltyPhoneAuto = document.getElementById('loyaltyPhoneAuto');
    const loyaltyAutoInfo = document.getElementById('loyaltyAutoInfo');
    const searchResults = document.getElementById('searchResults');
    const cartEl = document.getElementById('cart');
    const totalEl = document.getElementById('totalAmount');
    const loyaltyBonusEl = document.getElementById('loyaltyBonus');
    const priceCheckEl = document.getElementById('priceCheck');
    const priceValueEl = document.getElementById('priceValue');
    const barcodeDisplay = document.getElementById('barcodeDisplay');
    const barcodeImage = document.getElementById('barcodeImage');
    const barcodeProductInfo = document.getElementById('barcodeProductInfo');
    const onlineOrderForm = document.getElementById('onlineOrderForm');
    const archiveForm = document.getElementById('archiveForm');
    const f2SearchForm = document.getElementById('f2SearchForm');
    const f2SearchInput = document.getElementById('f2SearchInput');
    const f2SearchResults = document.getElementById('f2SearchResults');
    const recentReceiptsEl = document.getElementById('recentReceipts');
    const recentReceiptsList = document.getElementById('recentReceiptsList');

    // === Инициализация ===
    console.log("Каталог загружен:", Object.keys(CATALOG).length, "препаратов");
    updateCart();

    // === Статус наличия ===
    function getStockText(stock) {
      if (stock === 'in') return '<span class="stock-status in-stock">В наличии</span>';
      if (stock === 'low') return '<span class="stock-status low-stock">Заканчивается</span>';
      return '<span class="stock-status out-of-stock">Нет в наличии</span>';
    }

    // === Лояльность ===
    loyaltyPhoneAuto.addEventListener('input', () => {
      clearTimeout(loyaltyTimeout);
      const phone = loyaltyPhoneAuto.value.trim();
      if (!phone || phone.length < 10) {
        currentUser = null;
        loyaltyAutoInfo.innerHTML = '';
        return;
      }
      loyaltyTimeout = setTimeout(async () => {
        if (!db) {
          loyaltyAutoInfo.innerHTML = '<p style="color:#e74c3c;">Firebase недоступен</p>';
          return;
        }
        const snapshot = await db.ref('loyalty').orderByChild('phone').equalTo(phone).once('value');
        if (snapshot.exists()) {
          const data = Object.values(snapshot.val())[0];
          currentUser = { ...data, phone };
          loyaltyAutoInfo.innerHTML = `
            <div class="loyalty-info">
              <strong>${data.name}</strong><br>
              Бонусов: ${data.bonus || 0}<br>
              Любимый: ${data.favorite ? CATALOG[data.favorite]?.name || '—' : 'не выбран'}
            </div>
          `;
        } else {
          const name = prompt('Клиент не найден. Введите ФИО для регистрации:');
          if (name) {
            await db.ref('loyalty').push({ phone, name, dob: '', bonus: 0 });
            currentUser = { phone, name, bonus: 0 };
            loyaltyAutoInfo.innerHTML = `<div class="loyalty-info">Создана карта для ${name}</div>`;
          }
        }
      }, 500);
    });

    // === Обновление корзины ===
    function updateCart() {
      if (cart.length === 0) {
        cartEl.innerHTML = '<p>Корзина пуста</p>';
        totalEl.textContent = '0';
        loyaltyBonusEl.textContent = 'Бонусы: 0';
      } else {
        cartEl.innerHTML = '';
        let total = 0;
        cart.forEach((item, idx) => {
          const subtotal = item.price * item.qty;
          total += subtotal;
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <div class="cart-item-info">
              ${item.name} (${item.code})<br>
              ${getStockText(item.stock)}<br>
              <small>${item.price} ₽ × ${item.qty} = ${subtotal} ₽</small>
            </div>
            <div class="cart-item-controls">
              <input type="number" class="cart-item-qty" value="${item.qty}" min="1" data-index="${idx}" />
              <button class="add-more" data-index="${idx}">+</button>
            </div>
          `;
          cartEl.appendChild(div);
        });
        totalEl.textContent = total;
        let bonus = Math.floor(total * 0.05);
        if (currentUser && currentUser.favorite) {
          const favItem = cart.find(i => i.code === currentUser.favorite);
          if (favItem) bonus += Math.floor(favItem.price * favItem.qty * 0.05);
        }
        loyaltyBonusEl.textContent = `Бонусы: +${bonus}`;
        document.querySelectorAll('.cart-item-qty').forEach(input => {
          input.onchange = (e) => {
            const idx = e.target.dataset.index;
            const qty = parseInt(e.target.value);
            if (qty >= 1) {
              cart[idx].qty = qty;
              updateCart();
            }
          };
        });
        document.querySelectorAll('.add-more').forEach(btn => {
          btn.onclick = (e) => {
            const idx = e.target.dataset.index;
            cart[idx].qty += 1;
            updateCart();
            playSuccessBeep();
          };
        });
      }
    }

    // === Добавление в корзину ===
    function addToCart(code) {
      if (!CATALOG[code]) {
        playErrorBeep();
        alert(`Препарат не найден`);
        return;
      }
      if (CATALOG[code].stock === 'out') {
        playErrorBeep();
        alert(`Товар "${CATALOG[code].name}" отсутствует на складе!`);
        return;
      }
      const existing = cart.findIndex(item => item.code === code);
      if (existing !== -1) {
        cart[existing].qty += 1;
      } else {
        cart.push({ code, ...CATALOG[code], qty: 1 });
      }
      playSuccessBeep();
      updateCart();
      mainInput.value = '';
    }

    // === Основной ввод ===
    mainInput.addEventListener('input', () => {
      const query = mainInput.value.trim().toLowerCase();
      if (query.length < 2) {
        searchResults.style.display = 'none';
        const val = mainInput.value.trim();
        if (val.length === 13 && /^\d+$/.test(val)) {
          addToCart(val);
        }
        return;
      }
      const results = [];
      for (const [code, prod] of Object.entries(CATALOG)) {
        if (prod.name.toLowerCase().includes(query)) {
          results.push({ code, ...prod });
          if (results.length >= 10) break;
        }
      }
      if (results.length > 0) {
        searchResults.innerHTML = '';
        results.forEach(item => {
          const div = document.createElement('div');
          div.innerHTML = `${item.name} — ${item.price} ₽ [${item.code}]<br>${getStockText(item.stock)}`;
          div.onclick = () => {
            addToCart(item.code);
            searchResults.style.display = 'none';
          };
          searchResults.appendChild(div);
        });
        searchResults.style.display = 'block';
      } else {
        searchResults.style.display = 'none';
        const val = mainInput.value.trim();
        if (val.length === 13 && /^\d+$/.test(val)) {
          addToCart(val);
        }
      }
    });

    // === Проверка цены ===
    document.getElementById('priceCheckBtn').addEventListener('click', () => {
      const val = mainInput.value.trim();
      if (val.length === 13 && /^\d+$/.test(val) && CATALOG[val]) {
        priceValueEl.textContent = CATALOG[val].price;
        priceCheckEl.style.display = 'block';
        setTimeout(() => priceCheckEl.style.display = 'none', 2500);
        playSuccessBeep();
      } else {
        playErrorBeep();
        alert('Введите 13-значный штрихкод');
      }
    });

    // === Отмена ===
    document.getElementById('cancelItem').addEventListener('click', () => {
      if (cart.length === 0) return;
      const last = cart[cart.length - 1];
      if (last.qty > 1) {
        last.qty -= 1;
      } else {
        cart.pop();
      }
      playSuccessBeep();
      updateCart();
    });

    // === Печать чека ===
    document.getElementById('printReceiptBtn').addEventListener('click', () => {
      if (cart.length === 0) return alert('Корзина пуста');
      const printWindow = window.open('', '_blank');
      const now = new Date().toLocaleString('ru-RU');
      let itemsHtml = '';
      let total = 0;
      cart.forEach(item => {
        const line = item.price * item.qty;
        total += line;
        itemsHtml += `<div>${item.name} (${item.qty} шт) — ${line} ₽</div>`;
      });
      const bonusEarned = Math.floor(total * 0.05);
      printWindow.document.write(`
        <html><head><title>Чек — Аптека «Любовь»</title>
        <style>body{font-family:monospace; max-width:400px; margin:0 auto;}</style></head><body>
        <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:10px;">
          <h2>Аптека «Любовь»</h2>
          <div>ИНН: 7701234567</div>
          <div>г. Москва, ул. Здоровья, д. 10</div>
          <div>${now}</div>
        </div>
        <div style="margin:15px 0;">${itemsHtml}</div>
        <div style="border-top:1px dashed #000; padding-top:10px; font-weight:bold;">
          ИТОГО: ${total} ₽
        </div>
        <div>Бонусов начислено: ${bonusEarned}</div>
        <div style="margin-top:20px; text-align:center;">Спасибо за покупку!</div>
        </body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    });

    // === Оплата ===
    document.getElementById('checkoutBtn').addEventListener('click', async () => {
      if (cart.length === 0) return alert('Корзина пуста');
      const total = parseFloat(totalEl.textContent);
      let useBonus = 0;
      if (currentUser && (currentUser.bonus || 0) > 0) {
        useBonus = parseInt(prompt(`Доступно бонусов: ${currentUser.bonus}. Сколько списать?`) || '0');
        useBonus = Math.min(useBonus, currentUser.bonus, total);
      }
      const finalTotal = total - useBonus;
      const paid = parseFloat(prompt(`К оплате: ${finalTotal} руб.\nСколько дал клиент?`));
      if (!paid || paid < finalTotal) {
        playErrorBeep();
        return alert('Недостаточно средств');
      }
      playSuccessBeep();
      alert(`Сдача: ${(paid - finalTotal).toFixed(2)} руб.\nСпасибо!`);

      const receiptData = {
        items: cart.map(i => ({...i})),
        total,
        bonusUsed: useBonus,
        phone: currentUser?.phone || null,
        timestamp: Date.now()
      };

      // Сохранить в Firebase
      if (db) {
        await db.ref('receipts').push({
          ...receiptData,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        if (currentUser) {
          const earned = Math.floor(total * 0.05);
          const newBonus = (currentUser.bonus || 0) - useBonus + earned;
          await db.ref('loyalty').orderByChild('phone').equalTo(currentUser.phone).once('value')
            .then(snap => {
              const key = Object.keys(snap.val())[0];
              db.ref(`loyalty/${key}`).update({ bonus: newBonus });
            });
        }
      }

      // Добавить в последние чеки
      recentReceipts.unshift(receiptData);
      if (recentReceipts.length > 5) recentReceipts.pop();

      cart = [];
      updateCart();
      barcodeDisplay.style.display = 'none';
      loyaltyPhoneAuto.value = '';
      currentUser = null;
      loyaltyAutoInfo.innerHTML = '';
    });

    // === Последние чеки ===
    document.getElementById('recentReceiptsBtn').addEventListener('click', () => {
      recentReceiptsEl.style.display = recentReceiptsEl.style.display === 'none' ? 'block' : 'none';
      if (recentReceiptsEl.style.display === 'block') {
        if (recentReceipts.length === 0) {
          recentReceiptsList.innerHTML = '<p>Нет чеков</p>';
        } else {
          recentReceiptsList.innerHTML = recentReceipts.map(r => {
            const time = new Date(r.timestamp).toLocaleString();
            const items = r.items.map(i => i.name).join(', ');
            return `<div><strong>${time}</strong><br>Товары: ${items}<br>Итого: ${r.total} ₽</div><hr>`;
          }).join('');
        }
      }
    });

    // === F2: генерация штрихкода ===
    document.getElementById('generateBarcodeBtn').addEventListener('click', () => {
      f2SearchForm.style.display = 'block';
      f2SearchInput.focus();
    });

    f2SearchInput.addEventListener('input', () => {
      const query = f2SearchInput.value.trim().toLowerCase();
      if (query.length < 2) {
        f2SearchResults.style.display = 'none';
        return;
      }
      const results = [];
      for (const [code, prod] of Object.entries(CATALOG)) {
        if (prod.name.toLowerCase().includes(query)) {
          results.push({ code, ...prod });
          if (results.length >= 15) break;
        }
      }
      if (results.length > 0) {
        f2SearchResults.innerHTML = '';
        results.forEach(item => {
          const div = document.createElement('div');
          div.innerHTML = `${item.name} — ${item.price} ₽<br>${getStockText(item.stock)}`;
          div.onclick = () => {
            const newCode = generateEAN13("2000000");
            const url = `https://barcode.tec-it.com/barcode.ashx?data=${newCode}&code=EAN13&multiplebarcodes=false&translate-esc=on&unit=Fit&dpi=96`;
            barcodeImage.src = url;
            barcodeProductInfo.textContent = `Товар: ${item.name} | Новый штрихкод: ${newCode}`;
            barcodeDisplay.style.display = 'block';
            f2SearchForm.style.display = 'none';
            f2SearchInput.value = '';
            playSuccessBeep();
          };
          f2SearchResults.appendChild(div);
        });
        f2SearchResults.style.display = 'block';
      } else {
        f2SearchResults.style.display = 'none';
      }
    });

    // === Горячие клавиши ===
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('generateBarcodeBtn').click();
      }
      if (e.key === 'F3') {
        e.preventDefault();
        mainInput.focus();
        mainInput.select();
      }
      if (e.altKey && e.key === ' ') {
        e.preventDefault();
        document.getElementById('priceCheckBtn').click();
      }
    });

    // === Остальные формы (онлайн-заказ, архив) — без изменений ===
    document.getElementById('onlineOrderBtn').onclick = () => onlineOrderForm.style.display = onlineOrderForm.style.display === 'none' ? 'block' : 'none';
    document.getElementById('archiveBtn').onclick = () => archiveForm.style.display = archiveForm.style.display === 'none' ? 'block' : 'none';

    document.getElementById('submitOrder').addEventListener('click', async () => {
      const name = document.getElementById('clientName').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();
      const items = document.getElementById('orderItems').value.trim();
      if (!name || !phone || !items) {
        playErrorBeep();
        return alert('Заполните все поля');
      }
      if (!db) {
        playErrorBeep();
        return alert('Firebase недоступен');
      }
      await db.ref('online-orders').push({ name, phone, items, status: 'новый', timestamp: firebase.database.ServerValue.TIMESTAMP });
      playSuccessBeep();
      document.getElementById('orderStatus').textContent = '✅ Заказ отправлен!';
      setTimeout(() => {
        onlineOrderForm.style.display = 'none';
        document.getElementById('orderStatus').textContent = '';
      }, 2000);
    });

    document.getElementById('searchArchive').addEventListener('click', async () => {
      const query = document.getElementById('archiveQuery').value.trim();
      if (!query || !db) {
        playErrorBeep();
        return;
      }
      const resDiv = document.getElementById('archiveResults');
      resDiv.innerHTML = '<p>Поиск...</p>';
      let all = [];
      const r = await db.ref('receipts').once('value');
      if (r.exists()) Object.values(r.val()).forEach(x => all.push({type:'Чек', ...x}));
      const o = await db.ref('online-orders').once('value');
      if (o.exists()) Object.values(o.val()).forEach(x => all.push({type:'Заказ', ...x}));
      const filtered = all.filter(x => JSON.stringify(x).toLowerCase().includes(query.toLowerCase()));
      resDiv.innerHTML = filtered.length ? '' : '<p>Ничего не найдено</p>';
      filtered.forEach(x => {
        const d = document.createElement('div');
        d.innerHTML = `<strong>${x.type}</strong>: ${x.items?.length ? x.items.map(i=>i.name).join(', ') : x.items || '—'} | ${new Date(x.timestamp).toLocaleString()}`;
        resDiv.appendChild(d);
      });
      playSuccessBeep();
    });
  </script>
</body>
</html>
